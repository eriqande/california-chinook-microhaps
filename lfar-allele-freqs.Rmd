---
title: "LFAR Allele Freqs"
author: "Eric C. Anderson"
date: "Last Updated: `r Sys.Date()`"
output:
  html_document:
    df_print: paged
    toc: true
    toc_float: true
bibliography: "`r here::here('tex/citation.bib')`"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(message = FALSE)
knitr::opts_knit$set(root.dir = here::here())
start_time <- Sys.time()
```

# Input and Output Paths

```{r}
if(exists("snakemake")) {
  input_list <- snakemake@input
  output_list <- snakemake@output
} else {
  # inputs:
  input_list <- list(
    final_baseline = "data/subRoSA_baseline_rubias_loci_renamed_July_2024.csv.gz",
    pop_labels = "inputs/reference-collection-names.csv",
    locus_info = "inputs/Calif-Chinook-Amplicon-Panel-Information.csv"
  )
  # outputs:
  output_list <- list(
    lfar_tex_table = "tex/inputs/lfar-freqs.tex"
  )
}
# you can create the necessary output directories like this:
dump <- lapply(output_list, function(x)
  dir.create(dirname(x), recursive = TRUE, showWarnings = FALSE)
)
```



# Introduction

The goal here is simply to get the allele frequenccies in different reporting units
at the LFAR markers into a table format.  


First, get the baseline and attach the collection and repunit names that we want.
```{r, message=FALSE, warning=FALSE}
library(tidyverse)



# get the full baseline with the new markers, etc.  We will toss out some
# non-winter Sacto fish of unknown provenance
full_base <- read_csv(input_list$final_baseline)


# read the pop labels for proper sorting
pop_labels <- read_csv(input_list$pop_labels)

# rename those collections and repunits
full_base2 <- full_base %>%
  rename(old_name = collection) %>%
  select(-repunit) %>%
  left_join(pop_labels %>% select(-run_timing_group), by = join_by(old_name)) %>%
  select(-old_name) %>%
  select(indiv, repunit, collection, sample_type, everything())
  
# finally, get the order of collections and repunits we want
repunit_order <- rev(unique(pop_labels$repunit))
```

Now, whittle that down to just the LFAR and pivot it longer:
```{r}
lfar_base <- full_base2 %>%
  select(indiv:collection, starts_with("Ots_lfar")) %>%
  pivot_longer(
    cols = starts_with("Ots_lfar"), 
    names_to = c("locus", "gene_copy"),
    names_pattern = "^(.*)_([12])",
    values_to = "allele"
  )
```

And now we count up the alleles within repunits
```{r}
# first, get the multiallelic counts
lfar_cnts_MA <- lfar_base %>%
  filter(!is.na(allele)) %>%
  count(repunit, locus, allele)

# now we want to pick out the actual bases that are relevant and count the up
lfar_cnts <- lfar_cnts_MA %>%
  mutate(
    base = case_when(
      locus == "Ots_lfar001_34_00954022" ~ str_sub(allele, 1, 1),
      locus == "Ots_lfar002_34_01151770" ~ str_sub(allele, 2, 2)
    )
  ) %>%
  group_by(repunit, locus, base) %>%
  summarise(n = sum(n)) %>%
  ungroup() %>%
  complete(repunit, locus, base, fill = list(n = 0L)) %>%
  group_by(repunit, locus) %>%
  mutate(
    tot_n = sum(n),
    fract = n / tot_n
  ) %>%
  ungroup()

lfar_cnts
```

Now, we just want to focus on the alleles that are most frequent in the late-fall.
```{r}
focal <- lfar_cnts %>%
  filter(repunit == "CV-Late-Fall") %>%
  group_by(locus) %>%
  filter(n == max(n))

alle_tib <- lfar_cnts %>%
  semi_join(focal, by = join_by(locus, base)) %>%
  mutate(
    repunit_f = factor(repunit, levels = repunit_order),
    f = sprintf("%.3f", fract)
  ) %>%
  select(-repunit, -base, -n, -fract) %>%
  pivot_wider(names_from = locus, values_from = c(f, tot_n)) %>%
  arrange(repunit_f) %>%
  select(repunit_f, `f_Ots_lfar001_34_00954022`, `tot_n_Ots_lfar001_34_00954022`, `f_Ots_lfar002_34_01151770`, `tot_n_Ots_lfar002_34_01151770`)

alle_tib
```


Now, we will print this out without any column names so that we can use it in a TeX table.
```{r}
write_delim(alle_tib, delim = "&", eol = "\\tabularnewline\n", file = output_list$lfar_tex_table, col_names = FALSE)
```


And, as a final hurrah, we need to get the actual positions of those bases in Otsh_v2.0
in order to make the TeX column headers.

```{r}
locus_info <- read_csv(input_list$locus_info)

lfar_info <- locus_info %>%
  filter(str_detect(AmpliconName, "lfar"))

# for Ots_lfar001_34_00954022 the focal SNP is the first one
# for Ots_lfar002_34_01151770 the focal SNPs is the second one

# the positions in the amplicons are like this:
lfar_info %>%
  select(AmpliconName, SNPLocationsInAmpliconSequence)
```


So, 33 for the first and 66 for the second. And we can get the SNP positions
in the genome like this:
```{r}
lfar_info %>%
  mutate(
    Otsh_v2.0_snp_pos = case_when(
      AmpliconName == "Ots_lfar001_34_00954022" ~ AmpliconStartPos + 33 - 1,
      AmpliconName == "Ots_lfar002_34_01151770" ~ AmpliconStartPos + 99 - 1
    ),
    .after = Otsh_v2.0_chromosome
  )
```

So, we put those in the header of the TeX table for these.


# Citations

::: {#refs}
:::

# Session Info

```{r}
sessioninfo::session_info()
```

# Running Time

Running the code and rendering this notebook required approximately this much time:

```{r}
Sys.time() - start_time
```
